---
import { DUNGEON_MAP, dungeonNameToSlug } from "../../../lib/wow-constants";
import "./DungeonFilterSelect.scss";

interface Props {
  currentDungeon?: string; // slug
  currentRegion?: string;
  currentRealm?: string;
}

const {
  currentDungeon = "",
  currentRegion = "global",
  currentRealm = "",
} = Astro.props;

// convert DUNGEON_MAP to options array with slugs
const dungeonOptions = Object.entries(DUNGEON_MAP).map(([id, name]) => ({
  id: id,
  label: name,
  slug: dungeonNameToSlug(name),
}));

// helper to build url for a dungeon selection
// function buildDungeonURL(dungeonSlug: string): string {
//   if (currentRegion === "global") {
//     return `/challenge-mode/global/${dungeonSlug}`;
//   } else if (currentRealm === "all" || !currentRealm) {
//     return `/challenge-mode/${currentRegion}/all/${dungeonSlug}`;
//   } else {
//     return `/challenge-mode/${currentRegion}/${currentRealm}/${dungeonSlug}`;
//   }
// }
---

<div class="filter-group dungeon-filter-select">
  <label for="dungeon-filter">Dungeon</label>
  <select id="dungeon-filter">
    {
      dungeonOptions.map((option) => (
        <option value={option.slug} selected={option.slug === currentDungeon}>
          {option.label}
        </option>
      ))
    }
  </select>
</div>

<script>
  document.getElementById("dungeon-filter")?.addEventListener("change", (e) => {
    const select = e.target as HTMLSelectElement;
    const selectedSlug = select.value;

    const pathParts = window.location.pathname.split("/").filter((p) => p);
    const basePath =
      pathParts[0] === "test-challenge-mode"
        ? "test-challenge-mode"
        : "challenge-mode";

    // Find the season segment (default to season1)
    let seasonSlug = "season1";
    const seasonIndex = pathParts.findIndex((part) =>
      /^season\d+$/i.test(part),
    );
    if (seasonIndex >= 0) {
      seasonSlug = pathParts[seasonIndex];
    }

    const scopeParts =
      seasonIndex >= 0 ? pathParts.slice(seasonIndex + 1) : pathParts.slice(1);
    let region = "global";
    let realm = "all";

    if (scopeParts.length >= 2 && scopeParts[0] === "global") {
      region = "global";
      realm = "all";
    } else if (scopeParts.length >= 3) {
      region = scopeParts[0] || "global";
      realm = scopeParts[1] || "all";
    }

    let newPath: string;
    if (region === "global") {
      newPath = `/${basePath}/${seasonSlug}/global/${selectedSlug}`;
    } else {
      newPath = `/${basePath}/${seasonSlug}/${region}/${realm || "all"}/${selectedSlug}`;
    }

    window.location.href = newPath;
  });
</script>
