---
import type { LatestRunEntry } from "../../../lib/types";
import Table from "../../Table/Table.astro";
import TableRow from "../../Table/TableRow.astro";
import TableCell from "../../Table/TableCell.astro";
import { formatDurationMMSS } from "../../../lib/utils";
import { getDungeonIconUrl } from "../../../lib/dungeonIcons";
import TeamComposition from "../../Leaderboard/TeamComposition/TeamComposition.astro";
import "./StatusRunsTable.scss";

interface Props {
  runs: LatestRunEntry[];
}

const { runs = [] } = Astro.props;

const timeAgo = (timestamp: number) => {
  if (!timestamp) return "";
  const sec = Math.max(0, Math.floor((Date.now() - timestamp) / 1000));
  const mins = Math.floor(sec / 60);
  const hours = Math.floor(mins / 60);
  const days = Math.floor(hours / 24);
  if (days > 0) return `${days}d ago`;
  if (hours > 0) return `${hours}h ago`;
  if (mins > 0) return `${mins}m ago`;
  return `${sec}s ago`;
};
---

<Table mode="status">
  <!-- Header slot -->
  <div slot="header" class="table-header-cell">Dungeon</div>
  <div slot="header" class="table-header-cell">Time</div>
  <div slot="header" class="table-header-cell">Team</div>
  <div slot="header" class="table-header-cell">Realm</div>
  <div slot="header" class="table-header-cell">Last Run</div>
  <div slot="header" class="table-header-cell">Period</div>

  <!-- Body (default slot) -->
  {
    runs.length > 0 ? (
      runs.map((run) => {
        const duration = formatDurationMMSS(run.latest_run?.duration_ms || 0);
        const dungeonIconUrl = getDungeonIconUrl(
          run.dungeon_slug,
          run.dungeon_name,
        );
        const members = run.latest_run?.members || [];
        const timestamp = run.most_recent_iso || "";
        const ago = timeAgo(run.most_recent);

        return (
          <TableRow data-region={run.region.toLowerCase()}>
            <TableCell label="Dungeon">
              <div class="dungeon-cell">
                {dungeonIconUrl && (
                  <img
                    src={dungeonIconUrl}
                    alt={run.dungeon_name}
                    class="dungeon-icon"
                  />
                )}
                <span>{run.dungeon_name}</span>
              </div>
            </TableCell>
            <TableCell label="Time">{duration}</TableCell>
            <TableCell label="Team">
              <TeamComposition members={members} />
            </TableCell>
            <TableCell label="Realm">{run.realm_name}</TableCell>
            <TableCell label="Last Run">
              <span class="timestamp-cell">
                {timestamp}
                {ago && <span class="time-ago">({ago})</span>}
              </span>
            </TableCell>
            <TableCell label="Period">{run.period_id}</TableCell>
          </TableRow>
        );
      })
    ) : (
      <div class="table-empty">
        <p>No runs found.</p>
      </div>
    )
  }
</Table>
