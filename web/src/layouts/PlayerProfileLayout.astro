---
import Callout from "../components/Callout/Callout.astro";
import WoWClassColors from "../components/WoWClassColors.astro";
import PlayerSearch from "../components/PlayerSearch/PlayerSearch.astro";
import PlayerHeader from "../components/PlayerProfile/PlayerHeader/PlayerHeader.astro";
import PlayerEquipment from "../components/PlayerProfile/PlayerEquipment/PlayerEquipment.astro";
import PlayerBestRuns from "../components/PlayerProfile/PlayerBestRuns/PlayerBestRuns.astro";
import PageLayout from "./PageLayout.astro";
import type { PlayerProfileData, BestRun } from "../lib/types";
import "../styles/global.scss";
import "./PlayerProfileLayout.scss";

export interface Props {
  region?: string;
  realmSlug?: string;
  playerName?: string;
  playerData?: PlayerProfileData | null;
  error?: string | null;
}

const {
  region = "",
  realmSlug = "",
  playerName = "",
  playerData = null,
  error = null,
} = Astro.props;

const pageTitle = `${playerName} - ${realmSlug} | Player Profile`;

const player = playerData?.player;
const equipment = playerData?.equipment || {};

const requestedSeason =
  typeof Astro.url?.searchParams?.get === "function"
    ? Astro.url.searchParams.get("season")
    : null;

let currentSeasonId: string | null = null;
let currentSeasonData = null;
let seasonOptions: { id: string; label: string }[] = [];
const seasonRunsMap: Record<string, Record<string, BestRun>> = {};

if (player && player.seasons) {
  const seasonIds = Object.keys(player.seasons).sort(
    (a, b) => Number(b) - Number(a),
  );
  seasonOptions = seasonIds.map((id) => ({
    id,
    label: `Season ${id}`,
  }));

  if (seasonIds.length > 0) {
    if (requestedSeason && seasonIds.includes(requestedSeason)) {
      currentSeasonId = requestedSeason;
    } else {
      currentSeasonId = seasonIds[0];
    }
    currentSeasonData = currentSeasonId
      ? player.seasons[currentSeasonId]
      : null;
  }

  for (const seasonId of seasonIds) {
    const data = player.seasons[seasonId];
    seasonRunsMap[seasonId] = data?.best_runs || {};
  }
}

const bestRuns = currentSeasonData?.best_runs || {};
---

<PageLayout title={pageTitle} description="Player profile page">
  <body>
    <WoWClassColors />
    <div class="player-profile-layout">
      <Callout type="warning" title="Warning">
        <p>
          We're currently experiencing issues fetching player profile data from
          the Blizzard API.
        </p>
      </Callout>
      <PlayerSearch />

      <div class="player-profile-page">
        {
          error && (
            <div class="error-state">
              <div class="error-message">
                <h2>Error</h2>
                <p>{error}</p>
              </div>
            </div>
          )
        }

        {
          !player && !error && (
            <div class="error-state">
              <div class="error-message">
                <h2>Player Not Found</h2>
                <p>
                  Player "{playerName}" not found. Only players with complete
                  coverage (9/9 recorded dungeons) are included.
                </p>
              </div>
            </div>
          )
        }

        {
          player && currentSeasonData && (
            <>
              <PlayerHeader player={player} seasonData={currentSeasonData} />
              <PlayerEquipment equipment={equipment} />
              <PlayerBestRuns
                bestRuns={bestRuns}
                showSectionWrapper={true}
                playerRegion={player.region}
                playerRealmSlug={player.realm_slug}
                seasonId={currentSeasonId}
                seasonOptions={seasonOptions}
                seasonRuns={seasonRunsMap}
                mode="full"
              />
            </>
          )
        }
      </div>
    </div>
  </body>
</PageLayout>
